<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Roll Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* ============================================
               MACHINED METAL DESIGN SYSTEM
               Near-white bead-blasted aluminum
               ============================================ */

            /* Surface — Light bead-blasted aluminum (near white) */
            --bg: #e8e8ec;
            --bg-grain: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");

            /* Inset cavity colors */
            --cavity: #2a2a2c;
            --cavity-floor: #1a1a1c;
            --cavity-glow: rgba(255, 140, 50, 0.2);

            /* Text on aluminum — high contrast */
            --text-primary: #0a0a0c;
            --text-secondary: #3a3a3c;
            --text-tertiary: #5c5c60;
            --text-engraved: #78787c;

            /* LED colors */
            --led-off: #4a4a4e;
            --led-off-glow: transparent;
            --led-on: #ff9500;
            --led-on-glow: rgba(255, 149, 0, 0.6);
            --led-on-deep: #ff6b00;

            /* Text on dark surfaces */
            --text-light: #e5e5e7;
            --text-light-secondary: #a1a1a6;

            /* Chrome/metallic accents */
            --chrome-light: #ffffff;
            --chrome-mid: #d4d4d8;
            --chrome-dark: #71717a;
            --chrome-gradient: linear-gradient(135deg, #ffffff 0%, #a1a1a6 50%, #4a4a4e 100%);

            /* Accent — matches LED glow */
            --accent: var(--led-on);
            --accent-glow: var(--led-on-glow);
            --accent-deep: var(--led-on-deep);

            /* Physical shadows */
            --shadow-hard: 0 4px 0 rgba(0, 0, 0, 0.25);
            --shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-cavity: inset 0 4px 8px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-drop: 0 8px 16px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.1);

            /* Bevels */
            --bevel-light: rgba(255, 255, 255, 0.6);
            --bevel-dark: rgba(0, 0, 0, 0.2);

            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;

            /* Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-pill: 100px;

            /* Typography — larger, more accessible */
            --text-xs: 12px;
            --text-sm: 14px;
            --text-base: 16px;
            --text-md: 18px;
            --text-lg: 22px;
            --text-xl: 32px;
            --text-2xl: 40px;

            /* Layout */
            --max-width: 400px;
        }

        .dark {
            --bg: #2c2c2e;
            --bg-grain: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");

            --cavity: #0f0f10;
            --cavity-floor: #080809;

            --text-primary: #f0f0f2;
            --text-secondary: #a8a8ac;
            --text-tertiary: #68686c;
            --text-engraved: #58585c;

            --led-off: #3a3a3e;
            --led-on-glow: rgba(255, 149, 0, 0.7);

            --bevel-light: rgba(255, 255, 255, 0.08);
            --bevel-dark: rgba(0, 0, 0, 0.5);

            --shadow-hard: 0 4px 0 rgba(0, 0, 0, 0.6);
            --shadow-drop: 0 8px 16px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.4;
            letter-spacing: -0.01em;
        }

        /* Aluminum grain texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-grain);
            opacity: 0.03;
            pointer-events: none;
            z-index: 10000;
        }

        .app {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 var(--space-6);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            padding: var(--space-10) 0 var(--space-8);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .screen.active {
            display: flex;
            opacity: 1;
        }

        @media (prefers-reduced-motion: reduce) {
            .screen { transition: none; }
        }

        /* ============================================
           HEADER — Engraved text
           ============================================ */
        .header {
            margin-bottom: var(--space-8);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-1);
        }

        .header h1 {
            font-size: var(--text-xs);
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-engraved);
            text-shadow: 0 1px 0 var(--bevel-light);
        }

        .header h2 {
            font-size: var(--text-xl);
            font-weight: 700;
            letter-spacing: -0.03em;
            color: var(--text-primary);
        }

        /* ============================================
           THEME TOGGLE — Raised tactile button
           ============================================ */
        .theme-toggle {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: #f0f0f2;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--led-off);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.04),
                0 3px 0 #c0c0c4,
                0 4px 8px rgba(0, 0, 0, 0.1);
            transition:
                transform 0.12s cubic-bezier(0.34, 1.56, 0.64, 1),
                box-shadow 0.1s ease,
                color 0.1s ease;
            transform: translateY(0);
        }

        .theme-toggle:hover {
            background: #f4f4f6;
            color: var(--text-primary);
        }

        .theme-toggle:active {
            transform: translateY(2px);
            transition:
                transform 0.05s ease-out,
                box-shadow 0.05s ease-out;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 rgba(0, 0, 0, 0.05),
                0 1px 0 #b8b8bc,
                0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .theme-toggle:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            stroke-width: 1.5;
        }

        .theme-toggle .sun-icon { display: block; }
        .theme-toggle .moon-icon { display: none; }
        .dark .theme-toggle .sun-icon { display: none; }
        .dark .theme-toggle .moon-icon { display: block; }

        /* Dark mode theme toggle adjustments */
        .dark .theme-toggle {
            background: #3a3a3e;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2),
                0 3px 0 #1a1a1c,
                0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .dark .theme-toggle:hover {
            background: #4a4a4e;
        }

        .dark .theme-toggle:active {
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3),
                0 1px 0 #0f0f10,
                0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* ============================================
           SELECTOR GROUPS
           ============================================ */
        .selector-group {
            margin-bottom: var(--space-6);
        }

        .selector-label {
            font-size: var(--text-xs);
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-secondary);
            text-shadow: 0 1px 0 var(--bevel-light);
            margin-bottom: var(--space-3);
        }

        .selector-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }

        /* ============================================
           SELECTOR OPTION — Raised OP-1 style button
           ============================================ */
        .selector-option {
            position: relative;
            padding: var(--space-4);
            min-height: 76px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: var(--space-2);

            /* Flat top surface — solid color, no gradient */
            background: #f0f0f2;
            border: none;
            border-radius: var(--radius-md);

            /* OP-1 raised effect: crisp edges, hard shadow below */
            box-shadow:
                /* Top edge highlight — thin crisp line */
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                /* Bottom inner edge — slight darkening */
                inset 0 -1px 0 rgba(0, 0, 0, 0.04),
                /* Hard drop shadow underneath — the "thickness" */
                0 3px 0 #c0c0c4,
                /* Soft ambient shadow */
                0 4px 8px rgba(0, 0, 0, 0.1);

            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            /* Tactile spring transition */
            transition:
                transform 0.12s cubic-bezier(0.34, 1.56, 0.64, 1),
                box-shadow 0.1s ease,
                background 0.1s ease,
                color 0.1s ease;
            transform: translateY(0);
        }

        /* LED Icon — Off state (dark, inactive) */
        .selector-option .option-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--led-off);
            transition: all 0.2s ease;
            position: relative;
        }

        .selector-option .option-icon svg {
            width: 100%;
            height: 100%;
            stroke-width: 1.5;
        }

        /* LED indicator dot — positioned at top-right of button card */
        .selector-option::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 5px;
            height: 5px;
            background: var(--led-off);
            border-radius: 50%;
            opacity: 0.4;
            transition: all 0.2s ease;
        }

        .selector-option:hover {
            background: #f4f4f6;
            color: var(--text-primary);
        }

        .selector-option:hover .option-icon {
            color: var(--text-secondary);
        }

        /* LED dot brightens slightly on hover */
        .selector-option:hover::after {
            opacity: 0.6;
        }

        /* Pressed down momentarily — tactile click */
        .selector-option:active {
            transform: translateY(2px);
            transition:
                transform 0.05s ease-out,
                box-shadow 0.05s ease-out;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 rgba(0, 0, 0, 0.05),
                0 1px 0 #b8b8bc,
                0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .selector-option:focus-visible {
            outline: 2px solid var(--led-on);
            outline-offset: 2px;
        }

        /* Selected state — Depressed into softer dark grey */
        .selector-option.selected {
            transform: translateY(3px);
            background: #4a4a4e;
            box-shadow:
                /* Softer inset shadow — pressed into surface */
                inset 0 2px 6px rgba(0, 0, 0, 0.4),
                inset 0 1px 2px rgba(0, 0, 0, 0.25),
                /* No drop shadow — button is flush/recessed */
                0 0 0 transparent;
            color: var(--text-light);
        }

        /* LED Icon — On state (warm orange glow) */
        .selector-option.selected .option-icon {
            color: var(--led-on);
            filter:
                drop-shadow(0 0 3px var(--led-on-glow))
                drop-shadow(0 0 8px var(--led-on-glow))
                drop-shadow(0 0 12px rgba(255, 149, 0, 0.3));
        }

        /* LED indicator dot — glowing when selected */
        .selector-option.selected::after {
            background: var(--led-on);
            opacity: 1;
            box-shadow:
                0 0 4px var(--led-on),
                0 0 8px var(--led-on-glow),
                0 0 12px var(--led-on-glow);
        }

        /* Subtle edge glow on selected */
        .selector-option.selected::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: var(--radius-md);
            box-shadow: inset 0 0 0 1px rgba(255, 149, 0, 0.2);
            pointer-events: none;
        }

        /* ============================================
           PRIMARY BUTTON — Raised tactile (matches cards)
           ============================================ */
        .btn-primary {
            width: 100%;
            padding: var(--space-4) var(--space-6);
            min-height: 54px;
            margin-top: auto;

            background: #f0f0f2;
            border: none;
            border-radius: var(--radius-md);

            font-size: var(--text-md);
            font-weight: 600;
            color: var(--text-primary);

            cursor: pointer;
            -webkit-tap-highlight-color: transparent;

            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.04),
                0 3px 0 #c0c0c4,
                0 4px 8px rgba(0, 0, 0, 0.1);

            transition:
                transform 0.12s cubic-bezier(0.34, 1.56, 0.64, 1),
                box-shadow 0.1s ease,
                background 0.1s ease;
            transform: translateY(0);
        }

        .btn-primary:hover {
            background: #f4f4f6;
        }

        .btn-primary:active {
            transform: translateY(2px);
            transition:
                transform 0.05s ease-out,
                box-shadow 0.05s ease-out;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 rgba(0, 0, 0, 0.05),
                0 1px 0 #b8b8bc,
                0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .btn-primary:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .btn-primary:disabled {
            background: #d8d8dc;
            color: var(--text-tertiary);
            cursor: not-allowed;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                0 2px 0 #b8b8bc,
                0 3px 6px rgba(0, 0, 0, 0.06);
            transform: translateY(0);
        }

        /* Dark mode primary button */
        .dark .btn-primary {
            background: #3a3a3e;
            color: var(--text-light);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2),
                0 3px 0 #1a1a1c,
                0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .dark .btn-primary:hover {
            background: #4a4a4e;
        }

        .dark .btn-primary:active {
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3),
                0 1px 0 #0f0f10,
                0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .dark .btn-primary:disabled {
            background: #2a2a2e;
            color: var(--text-tertiary);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                0 2px 0 #1a1a1c,
                0 3px 6px rgba(0, 0, 0, 0.2);
        }

        /* ============================================
           SECONDARY BUTTON — Raised tactile (softer)
           ============================================ */
        .btn-secondary {
            width: 100%;
            padding: var(--space-4) var(--space-6);
            min-height: 54px;

            background: #f0f0f2;
            border: none;
            border-radius: var(--radius-md);

            font-size: var(--text-md);
            font-weight: 600;
            color: var(--text-secondary);

            cursor: pointer;
            -webkit-tap-highlight-color: transparent;

            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.04),
                0 3px 0 #c0c0c4,
                0 4px 8px rgba(0, 0, 0, 0.1);

            transition:
                transform 0.12s cubic-bezier(0.34, 1.56, 0.64, 1),
                box-shadow 0.1s ease,
                background 0.1s ease;
            transform: translateY(0);
        }

        .btn-secondary:hover {
            background: #f4f4f6;
            color: var(--text-primary);
        }

        .btn-secondary:active {
            transform: translateY(2px);
            transition:
                transform 0.05s ease-out,
                box-shadow 0.05s ease-out;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 rgba(0, 0, 0, 0.05),
                0 1px 0 #b8b8bc,
                0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .btn-secondary:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Dark mode secondary button */
        .dark .btn-secondary {
            background: #3a3a3e;
            color: var(--text-light-secondary);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2),
                0 3px 0 #1a1a1c,
                0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .dark .btn-secondary:hover {
            background: #4a4a4e;
            color: var(--text-light);
        }

        .dark .btn-secondary:active {
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3),
                0 1px 0 #0f0f10,
                0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* ============================================
           FILM CARD — Recessed panel (softer dark)
           ============================================ */
        .film-card {
            background: #4a4a4e;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow:
                inset 0 2px 6px rgba(0, 0, 0, 0.3),
                inset 0 1px 2px rgba(0, 0, 0, 0.15),
                0 1px 0 var(--bevel-light);
            color: var(--text-light);
        }

        .film-stock {
            font-size: var(--text-xl);
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #ffffff;
            margin-bottom: var(--space-2);
        }

        .film-ei {
            font-size: var(--text-md);
            font-weight: 600;
            color: var(--accent);
            margin-bottom: var(--space-5);
        }

        .film-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.15);
            margin: var(--space-5) 0;
        }

        .film-detail {
            margin-bottom: var(--space-4);
        }

        .film-detail:last-child {
            margin-bottom: 0;
        }

        .film-detail-label {
            font-size: var(--text-xs);
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #a8a8ac;
            margin-bottom: var(--space-2);
        }

        .film-detail-value {
            font-size: var(--text-md);
            font-weight: 500;
            color: #f0f0f2;
            line-height: 1.6;
        }

        .film-discipline {
            font-size: var(--text-base);
            font-style: italic;
            font-weight: 500;
            color: #a8a8ac;
            text-align: center;
            padding-top: var(--space-5);
            margin-top: var(--space-5);
            border-top: 1px solid rgba(255, 255, 255, 0.12);
        }

        /* ============================================
           SPACER
           ============================================ */
        .spacer {
            flex: 1;
            min-height: var(--space-6);
        }

        /* ============================================
           BACK LINK
           ============================================ */
        .back-link {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            margin-bottom: var(--space-4);
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) 0;
            transition: color 0.15s ease;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        .back-link:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }

        /* ============================================
           SKIP LINK (Accessibility)
           ============================================ */
        .skip-link {
            position: absolute;
            top: -100%;
            left: var(--space-4);
            padding: var(--space-3) var(--space-5);
            background: var(--cavity);
            color: var(--text-light);
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: var(--text-sm);
            z-index: 10001;
            text-decoration: none;
            box-shadow: var(--shadow-drop);
        }

        .skip-link:focus {
            top: var(--space-4);
        }

        /* ============================================
           LOCKED SCREEN
           ============================================ */
        .locked-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
        }

        .locked-meta {
            font-size: var(--text-sm);
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-secondary);
            text-shadow: 0 1px 0 var(--bevel-light);
        }

        .locked-date {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .locked-hero {
            text-align: center;
            padding: var(--space-10) 0;
        }

        .locked-film-name {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.03em;
            line-height: 1.1;
            margin-bottom: var(--space-3);
        }

        .locked-film-ei {
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--accent);
        }

        .locked-guidance {
            background: #4a4a4e;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow:
                inset 0 2px 6px rgba(0, 0, 0, 0.3),
                inset 0 1px 2px rgba(0, 0, 0, 0.15),
                0 1px 0 var(--bevel-light);
        }

        .locked-guidance-text {
            font-size: var(--text-md);
            font-weight: 500;
            color: #f0f0f2;
            line-height: 1.6;
            text-align: center;
        }

        .locked-discipline {
            font-size: var(--text-base);
            font-style: italic;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: center;
            padding: var(--space-5) 0;
        }

        /* ============================================
           LOCATION BAR — Dark grey with LED
           ============================================ */
        .location-bar {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: #4a4a4e;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-6);
            box-shadow:
                inset 0 2px 4px rgba(0, 0, 0, 0.25),
                inset 0 1px 2px rgba(0, 0, 0, 0.15),
                0 1px 0 var(--bevel-light);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .location-bar:hover {
            background: #555558;
        }

        .location-bar.active {
            cursor: default;
        }

        .location-bar.active:hover {
            background: #4a4a4e;
        }

        /* LED indicator */
        .location-led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--led-off);
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .location-bar.active .location-led {
            background: var(--led-on);
            box-shadow:
                0 0 4px var(--led-on),
                0 0 8px var(--led-on-glow),
                0 0 12px var(--led-on-glow);
        }

        .location-bar.loading .location-led {
            animation: led-pulse 1s ease-in-out infinite;
        }

        @keyframes led-pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .location-text {
            flex: 1;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #68686c;
            transition: color 0.15s ease;
        }

        .location-bar.active .location-text {
            color: var(--led-on);
            text-shadow: 0 0 8px var(--led-on-glow);
        }

        .location-icon {
            width: 16px;
            height: 16px;
            color: #78787c;
            flex-shrink: 0;
        }

        .location-bar.active .location-icon {
            display: none;
        }

        /* Dark mode adjustments */
        .dark .location-bar {
            background: #1a1a1c;
            box-shadow:
                inset 0 2px 4px rgba(0, 0, 0, 0.4),
                inset 0 1px 2px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .dark .location-bar:hover {
            background: #242426;
        }

        .dark .location-bar.active:hover {
            background: #1a1a1c;
        }

    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="app" id="main-content">
        <!-- Screen 1: Set the conditions -->
        <div class="screen active" id="screen-conditions">
            <div class="header">
                <div class="header-row">
                    <h1>Roll Planner</h1>
                    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
                        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                </div>
                <h2>Set the conditions</h2>
            </div>

            <!-- Location bar -->
            <div class="location-bar" id="location-bar" role="button" tabindex="0">
                <span class="location-led"></span>
                <span class="location-text" id="location-text">TAP FOR LOCATION</span>
                <svg class="location-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
            </div>

            <div class="selector-group">
                <div class="selector-label">Light</div>
                <div class="selector-options" data-selector="light">
                    <div class="selector-option" data-value="flat">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>
                            </svg>
                        </span>
                        Flat
                    </div>
                    <div class="selector-option" data-value="harsh">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="4"/>
                                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
                            </svg>
                        </span>
                        Harsh
                    </div>
                    <div class="selector-option" data-value="golden">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 10V2M18.4 6.6l-1.42 1.42M22 12h-8M18.4 17.4l-1.42-1.42M12 22v-8M5.6 17.4l1.42-1.42M2 12h8M5.6 6.6l1.42 1.42"/>
                                <circle cx="12" cy="12" r="4"/>
                            </svg>
                        </span>
                        Golden
                    </div>
                    <div class="selector-option" data-value="mixed">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2v2M5.6 5.6l1.4 1.4M2 12h2M5.6 18.4l1.4-1.4"/>
                                <path d="M20 15.5a4.5 4.5 0 0 0-4.5-4.5H15a5.5 5.5 0 0 0-10.7 2"/>
                                <path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/>
                            </svg>
                        </span>
                        Mixed
                    </div>
                </div>
            </div>

            <div class="selector-group">
                <div class="selector-label">Environment</div>
                <div class="selector-options" data-selector="environment">
                    <div class="selector-option" data-value="street">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 21h18M5 21V7l8-4 8 4v14M9 21v-6h6v6"/>
                                <path d="M9 9h.01M15 9h.01M9 13h.01M15 13h.01"/>
                            </svg>
                        </span>
                        Street
                    </div>
                    <div class="selector-option" data-value="architecture">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="4" y="2" width="16" height="20" rx="2"/>
                                <path d="M9 22v-4h6v4M8 6h.01M16 6h.01M12 6h.01M8 10h.01M16 10h.01M12 10h.01M8 14h.01M16 14h.01M12 14h.01"/>
                            </svg>
                        </span>
                        Architecture
                    </div>
                    <div class="selector-option" data-value="interiors">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                        </span>
                        Interiors
                    </div>
                    <div class="selector-option" data-value="landscape">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m8 3 4 8 5-5 5 15H2L8 3z"/>
                                <path d="M4.14 15.08c2.62-1.57 5.24-1.43 7.86.42 2.74 1.94 5.49 2 8.23.19"/>
                            </svg>
                        </span>
                        Landscape
                    </div>
                </div>
            </div>

            <div class="selector-group">
                <div class="selector-label">Intent</div>
                <div class="selector-options" data-selector="intent">
                    <div class="selector-option" data-value="calm">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="9"/>
                                <circle cx="12" cy="12" r="1"/>
                            </svg>
                        </span>
                        Minimal
                    </div>
                    <div class="selector-option" data-value="graphic">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18M9 21V9"/>
                            </svg>
                        </span>
                        Graphic
                    </div>
                    <div class="selector-option" data-value="emotional">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                            </svg>
                        </span>
                        Expressive
                    </div>
                    <div class="selector-option" data-value="documentary">
                        <span class="option-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </span>
                        Documentary
                    </div>
                </div>
            </div>

            <div class="spacer"></div>

            <button class="btn-primary" id="btn-continue" disabled>Continue</button>
        </div>

        <!-- Screen 2: Your roll -->
        <div class="screen" id="screen-recommendation">
            <span class="back-link" id="btn-back-conditions" role="button" tabindex="0">← Back</span>

            <div class="header">
                <div class="header-row">
                    <h1>Roll Planner</h1>
                </div>
                <h2>Your roll</h2>
            </div>

            <div class="film-card">
                <div class="film-stock" id="rec-film"></div>
                <div class="film-ei" id="rec-ei"></div>

                <div class="film-divider"></div>

                <div class="film-detail">
                    <div class="film-detail-label">Exposure approach</div>
                    <div class="film-detail-value" id="rec-exposure"></div>
                </div>

                <div class="film-discipline" id="rec-discipline"></div>
            </div>

            <div class="spacer"></div>

            <button class="btn-primary" id="btn-lock">Lock this roll</button>
        </div>

        <!-- Screen 3: Roll locked -->
        <div class="screen" id="screen-locked">
            <div class="locked-header">
                <span class="locked-meta">Roll <span id="roll-number">001</span></span>
                <span class="locked-date" id="locked-date"></span>
            </div>

            <div class="locked-hero">
                <div class="locked-film-name" id="locked-film">Portra 400</div>
                <div class="locked-film-ei" id="locked-ei">EI 400</div>
            </div>

            <div class="locked-guidance">
                <div class="locked-guidance-text" id="locked-exposure">Expose for midtones.</div>
            </div>

            <div class="locked-discipline" id="locked-discipline">"Keep it simple."</div>

            <div class="spacer"></div>

            <button class="btn-secondary" id="btn-start-over">New roll</button>
        </div>

    </div>

    <script>
        // State
        const state = {
            light: null,
            environment: null,
            intent: null,
            recommendation: null,
            locked: false,
            rollNumber: null,
            lockedAt: null
        };

        // Roll counter management
        function getNextRollNumber() {
            const counter = parseInt(localStorage.getItem('rollplanner_roll_counter') || '0', 10);
            const nextNumber = counter + 1;
            localStorage.setItem('rollplanner_roll_counter', nextNumber.toString());
            return nextNumber;
        }

        function formatRollNumber(num) {
            return num.toString().padStart(3, '0');
        }

        // Discipline sentences by intent
        const disciplines = {
            calm: 'Slow down. Wait for stillness.',
            graphic: 'Find the geometry. Commit to the frame.',
            emotional: 'Follow the feeling, not the subject.',
            documentary: "Stay present. Don't chase moments."
        };

        // Recommendation engine
        function getRecommendation(light, environment, intent) {
            // Golden light
            if (light === 'golden') {
                if (intent === 'emotional') {
                    return { film: 'Portra 160', ei: 100, exposure: 'Protect highlights. Let the warm tones breathe.' };
                }
                if (environment === 'landscape' && intent === 'calm') {
                    return { film: 'Ektar 100', ei: 100, exposure: 'Protect highlights. Meter for the brightest tones.' };
                }
                return { film: 'Portra 400', ei: 320, exposure: 'Protect highlights. A touch of overexposure suits this light.' };
            }

            // Harsh light
            if (light === 'harsh') {
                if (environment === 'street' && intent === 'documentary') {
                    return { film: 'HP5', ei: 800, exposure: 'Let shadows fall. Embrace the contrast.' };
                }
                if (environment === 'architecture' && intent === 'graphic') {
                    return { film: 'FP4', ei: 64, exposure: 'Protect highlights. Watch for blown whites on surfaces.' };
                }
                return { film: 'Portra 400', ei: 200, exposure: 'Protect highlights. Portra handles harsh light gracefully.' };
            }

            // Flat light
            if (light === 'flat') {
                if (environment === 'interiors') {
                    return { film: 'Portra 400', ei: 800, exposure: 'Expose for shadows. Interior light falls off quickly.' };
                }
                if (intent === 'calm') {
                    return { film: 'Portra 160', ei: 160, exposure: 'Meter for midtones. Flat light is forgiving.' };
                }
                if (intent === 'documentary') {
                    return { film: 'HP5', ei: 400, exposure: 'Expose for shadows. The grain will add texture.' };
                }
                return { film: 'Portra 400', ei: 400, exposure: 'Meter for midtones. Trust the latitude.' };
            }

            // Mixed light
            if (light === 'mixed') {
                if (environment === 'street' && intent === 'documentary') {
                    return { film: 'Ultramax 400', ei: 400, exposure: 'Protect highlights. The film handles mixed tones well.' };
                }
                if (intent === 'emotional') {
                    return { film: 'Gold 200', ei: 200, exposure: 'Protect highlights. Lean into the warm cast.' };
                }
                return { film: 'Portra 400', ei: 400, exposure: 'Meter for highlights. Adapt as conditions shift.' };
            }

            // Fallback
            return { film: 'Portra 400', ei: 400, exposure: 'Meter for midtones. A versatile choice.' };
        }

        // DOM elements
        const screens = {
            conditions: document.getElementById('screen-conditions'),
            recommendation: document.getElementById('screen-recommendation'),
            locked: document.getElementById('screen-locked')
        };

        const btnContinue = document.getElementById('btn-continue');
        const btnLock = document.getElementById('btn-lock');
        const btnStartOver = document.getElementById('btn-start-over');
        const btnBackConditions = document.getElementById('btn-back-conditions');

        // Show screen
        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
        }

        // Update continue button state
        function updateContinueButton() {
            const allSelected = state.light && state.environment && state.intent;
            btnContinue.disabled = !allSelected;
        }

        // Selector click handlers
        document.querySelectorAll('.selector-options').forEach(group => {
            const selectorName = group.dataset.selector;

            group.querySelectorAll('.selector-option').forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected from siblings
                    group.querySelectorAll('.selector-option').forEach(o => o.classList.remove('selected'));
                    // Add selected to clicked
                    option.classList.add('selected');
                    // Update state
                    state[selectorName] = option.dataset.value;
                    updateContinueButton();
                });
            });
        });

        // Continue button
        btnContinue.addEventListener('click', () => {
            if (btnContinue.disabled) return;

            // Generate recommendation
            state.recommendation = getRecommendation(
                state.light,
                state.environment,
                state.intent
            );

            // Update recommendation screen
            document.getElementById('rec-film').textContent = state.recommendation.film;
            document.getElementById('rec-ei').textContent = `Rate at EI ${state.recommendation.ei}`;
            document.getElementById('rec-exposure').textContent = state.recommendation.exposure;
            document.getElementById('rec-discipline').textContent = disciplines[state.intent];

            showScreen('recommendation');
        });

        // Back to conditions
        btnBackConditions.addEventListener('click', () => {
            showScreen('conditions');
        });

        // Lock button
        btnLock.addEventListener('click', () => {
            state.locked = true;
            state.rollNumber = getNextRollNumber();
            state.lockedAt = new Date().toISOString();

            // Save to local storage
            localStorage.setItem('rollplanner_current', JSON.stringify(state));

            // Update locked display
            updateLockedDisplay();

            showScreen('locked');
        });

        // Update locked card display
        function updateLockedDisplay() {
            const now = new Date(state.lockedAt);

            // Header
            document.getElementById('roll-number').textContent = formatRollNumber(state.rollNumber);

            // Date
            const dateStr = now.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            document.getElementById('locked-date').textContent = dateStr;

            // Film & EI
            document.getElementById('locked-film').textContent = state.recommendation.film;
            document.getElementById('locked-ei').textContent = `EI ${state.recommendation.ei}`;

            // Exposure guidance
            document.getElementById('locked-exposure').textContent = state.recommendation.exposure;

            // Discipline
            document.getElementById('locked-discipline').textContent = `"${disciplines[state.intent]}"`;
        }

        // Start over
        btnStartOver.addEventListener('click', () => {
            // Clear state
            state.light = null;
            state.environment = null;
            state.intent = null;
            state.recommendation = null;
            state.locked = false;

            // Clear local storage
            localStorage.removeItem('rollplanner_current');

            // Clear UI selections
            document.querySelectorAll('.selector-option').forEach(o => o.classList.remove('selected'));

            updateContinueButton();
            showScreen('conditions');
        });

        // Check for existing locked roll on load
        function init() {
            try {
                const saved = localStorage.getItem('rollplanner_current');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.locked && data.recommendation) {
                        // Restore state
                        Object.assign(state, data);

                        // Update locked display
                        updateLockedDisplay();

                        showScreen('locked');
                    }
                }
            } catch (e) {
                // Clear corrupted data
                localStorage.removeItem('rollplanner_current');
                console.error('Cleared corrupted localStorage:', e);
            }
        }

        init();

        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');

        function getStoredTheme() {
            return localStorage.getItem('rollplanner_theme');
        }

        function getPreferredTheme() {
            const stored = getStoredTheme();
            if (stored) return stored;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('rollplanner_theme', theme);
        }

        // Initialize theme
        setTheme(getPreferredTheme());

        // Toggle handler
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        // Listen for system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!getStoredTheme()) {
                setTheme(e.matches ? 'dark' : 'light');
            }
        });

        // Add keyboard support for back link
        btnBackConditions.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                showScreen('conditions');
            }
        });

        // Add keyboard support for selector options
        document.querySelectorAll('.selector-option').forEach(option => {
            option.setAttribute('tabindex', '0');
            option.setAttribute('role', 'button');
            option.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    option.click();
                }
            });
        });

        // ============================================
        // GEOLOCATION & WEATHER
        // ============================================
        const locationBar = document.getElementById('location-bar');
        const locationText = document.getElementById('location-text');

        // Store location data in state
        state.location = null;
        state.weather = null;

        async function fetchWeather(lat, lon) {
            try {
                // Using Open-Meteo API (free, no key required)
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,cloud_cover&timezone=auto`
                );
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Weather fetch failed:', error);
                return null;
            }
        }

        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(
                    `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`
                );
                const data = await response.json();
                // Get the cleanest city name - prefer city, then look for short names
                // Avoid district names like "Amphoe Mueang..."
                let city = data.city || null;

                // If city contains "Amphoe" or is too long, try alternatives
                if (!city || city.includes('Amphoe') || city.includes('District') || city.length > 15) {
                    // Try principalSubdivision (state/province) which is often cleaner
                    const province = data.principalSubdivision;
                    if (province && province.length <= 15) {
                        city = province;
                    } else if (data.locality && data.locality.length <= 15) {
                        city = data.locality;
                    }
                }

                // Final cleanup - extract just the main city name if still too long
                if (city && city.length > 15) {
                    // Try to get just the last meaningful part (often the city name)
                    const parts = city.split(' ');
                    if (parts.length > 1) {
                        city = parts[parts.length - 1];
                    }
                }

                return city;
            } catch (error) {
                console.error('Geocode failed:', error);
                return null;
            }
        }

        function formatCity(city) {
            if (!city) return 'LOC';
            // Truncate to max 12 chars for display
            const name = city.toUpperCase();
            return name.length > 12 ? name.substring(0, 12) : name;
        }

        function getConditionsDescription(code, cloudCover, visibility) {
            // Focus on visibility and light conditions for photography
            // WMO Weather codes - simplified to photography-relevant terms
            if (code >= 45 && code <= 48) return 'FOG';
            if (code >= 51 && code <= 57) return 'DRIZZLE';
            if (code >= 61 && code <= 67) return 'RAIN';
            if (code >= 71 && code <= 77) return 'SNOW';
            if (code >= 80 && code <= 82) return 'SHOWERS';
            if (code >= 95) return 'STORM';

            // Clear conditions - use cloud cover
            if (cloudCover <= 10) return 'CLEAR';
            if (cloudCover <= 30) return 'FEW CLOUDS';
            if (cloudCover <= 60) return 'CLOUDY';
            if (cloudCover <= 85) return 'OVERCAST';
            return 'HEAVY CLOUD';
        }

        async function handleLocationRequest() {
            if (locationBar.classList.contains('active') || locationBar.classList.contains('loading')) {
                return;
            }

            locationBar.classList.add('loading');
            locationText.textContent = 'LOCATING...';

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    });
                });

                const { latitude, longitude } = position.coords;
                state.location = { lat: latitude, lon: longitude };

                // Fetch city name and weather in parallel
                const [cityName, weatherData] = await Promise.all([
                    reverseGeocode(latitude, longitude),
                    fetchWeather(latitude, longitude)
                ]);

                locationBar.classList.remove('loading');
                locationBar.classList.add('active');

                const displayCity = formatCity(cityName);

                if (weatherData && weatherData.current) {
                    const conditions = getConditionsDescription(
                        weatherData.current.weather_code,
                        weatherData.current.cloud_cover
                    );
                    state.weather = {
                        conditions,
                        cloudCover: weatherData.current.cloud_cover
                    };
                    // Format: "CITY // CONDITIONS"
                    locationText.textContent = `${displayCity} // ${conditions}`;
                } else {
                    // No weather data - show city with unknown conditions
                    state.weather = { conditions: 'UNKNOWN', cloudCover: null };
                    locationText.textContent = `${displayCity} // UNKNOWN`;
                }

                // Save to localStorage
                localStorage.setItem('rollplanner_location', JSON.stringify({
                    lat: latitude,
                    lon: longitude,
                    city: cityName,
                    weather: state.weather,
                    timestamp: Date.now()
                }));

            } catch (error) {
                locationBar.classList.remove('loading');
                if (error.code === 1) {
                    locationText.textContent = 'ACCESS DENIED';
                } else if (error.code === 2) {
                    locationText.textContent = 'UNAVAILABLE';
                } else {
                    locationText.textContent = 'TIMEOUT';
                }
                console.error('Geolocation error:', error);
            }
        }

        // Check for cached location on load
        function initLocation() {
            const cached = localStorage.getItem('rollplanner_location');
            if (cached) {
                try {
                    const data = JSON.parse(cached);
                    // Use cache if less than 30 minutes old
                    if (Date.now() - data.timestamp < 30 * 60 * 1000) {
                        state.location = { lat: data.lat, lon: data.lon };
                        state.weather = data.weather;
                        locationBar.classList.add('active');
                        if (data.weather && data.weather.conditions) {
                            const displayCity = formatCity(data.city);
                            locationText.textContent = `${displayCity} // ${data.weather.conditions}`;
                        } else {
                            locationText.textContent = formatCity(data.city);
                        }
                    }
                } catch (e) {
                    localStorage.removeItem('rollplanner_location');
                }
            }
        }

        initLocation();

        // Location bar click handler
        locationBar.addEventListener('click', handleLocationRequest);
        locationBar.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleLocationRequest();
            }
        });
    </script>
</body>
</html>
